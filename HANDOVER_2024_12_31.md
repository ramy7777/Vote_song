# Vote Song Project Handover Document
**Date: December 31, 2024**

## Project Overview
Vote Song is a real-time web application that allows users to host music voting sessions. One user acts as a host while others join as participants to vote on songs. The application features real-time synchronization, audio playback, and interactive voting mechanics.

## Technical Stack
- **Backend**: Node.js with Express and Socket.IO
- **Frontend**: Vanilla JavaScript, HTML5, CSS3
- **Real-time Communication**: Socket.IO
- **Audio Playback**: HTML5 Audio API
- **Dependencies**: See package.json for full list

## Core Components

### 1. Server (server.js)
#### State Management
- `gameState`: Tracks current game status
  - `isVoting`: Boolean for voting phase
  - `currentSong`: Currently playing song
  - `host`: Socket ID of host
  - `canStart`: Boolean for game start conditions
  - `lastActivityTime`: Timestamp for inactivity tracking
  - `gameStarted`: Boolean to track if session has started
  - `currentTime`: Current playback position
  - `lastTimeUpdate`: Last sync timestamp
- `activeQuickSession`: Tracks current quick join session
- `participants`: Map of connected users
- `votes`: Map of user votes
- `songs`: Array of song objects

#### Key Functions
- `resetGameState()`: Resets votes and game state
- `updateLastActivity()`: Updates activity timestamp
- `handleInactivity()`: Manages 5-minute timeout
- `isHost()`: Validates host status
- `getOrCreateSession()`: Manages session creation/retrieval
- `broadcastTime()`: Sends current time to clients
- `handleSync()`: Manages audio synchronization
- `calculateLatency()`: Computes network latency

#### Socket Events
- `connection`: New user connection
- `joinVoting`: User joining regular session
- `quickJoin`: Handles quick join functionality
- `startGame`: Host starting game
- `vote`: User casting vote
- `hostControl`: Host audio controls
- `disconnect`: User disconnection
- `ping`: Latency measurement request
- `pong`: Latency measurement response
- `syncTime`: Time synchronization broadcast
- `audioState`: Audio state update
- `requestSync`: Client sync request

### 2. Client (app.js)
#### State Management
- `domElements`: References to UI elements
- `isHost`: Boolean for host status
- `hasVoted`: Boolean for user vote status
- `audioContextInitialized`: Audio context state
- `currentSessionId`: Tracks current session ID
- `networkLatency`: Current network latency
- `lastPing`: Timestamp of last ping
- `pendingPlay`: Tracks pending play state
- `playbackRate`: Current playback speed

#### Key Functions
- `initializeDOMElements()`: Sets up UI references
- `updateSongsDisplay()`: Updates song list UI
- `showScreen()`: Manages screen transitions
- `playSong()`: Handles audio playback
- `voteSong()`: Processes user votes
- `updateNetworkLatency()`: Updates latency measurements
- `handleDriftCorrection()`: Corrects playback drift
- `initAudioContext()`: Sets up audio context
- `syncWithHost()`: Syncs with host time
- `handlePlaybackRate()`: Manages playback speed

#### Socket Events
- `updateParticipants`: Updates player list
- `hostStatus`: Updates host status
- `gameState`: Updates game state
- `updateVotes`: Updates vote counts
- `sessionJoined`: Handles session join confirmation
- `disconnect`: Handles server disconnection

### 3. User Interface (index.html, style.css)
#### Screens
1. **Join Screen**
   - Username input
   - Quick Join button
   - Custom room creation:
     - Optional room ID input
     - Create session button
   - Join existing room:
     - Room ID input
     - Join button

2. **Waiting Screen**
   - Room ID display
   - Participant count
   - Start game button (host only)
   - Player list

3. **Voting Screen**
   - Song list with vote counts
   - Vote buttons
   - Voter names display
   - Visual feedback for votes

4. **Current Song Screen**
   - Song details
   - Audio controls (host only)
   - Return to voting button

## Core Workflows

### 1. Game Initialization
1. Users can join in two ways:
   - Quick Join: First user becomes host, others auto-join
   - Custom Room: Create with custom ID or join existing room
2. Host starts game when 2-30 players present
3. System transitions to voting phase

### 2. Session Types
#### Quick Join Sessions
- First user clicking Quick Join becomes host
- Generates random room ID
- Subsequent Quick Join clicks auto-join this session
- Session cleared when host disconnects
- Can start with minimum 1 player
- Late joiners sync to current game state

#### Custom Room Sessions
- Host creates room with custom ID (min 1 character)
- System validates ID uniqueness
- Players join using room ID
- Host migration available on disconnect
- Can start with minimum 1 player
- Late joiners sync to current game state

### 3. Voting Process
1. All users see song list
2. Users can vote once per round
3. Votes update in real-time
4. Visual feedback shows voted songs
5. Voter names display under songs

### 4. Song Playback
1. Host controls audio playback
2. All users sync to host's timeline
3. Audio state syncs across all users
4. iOS devices use tap-to-play feature

### 5. Audio Synchronization
1. **Network Latency Compensation**
   - Regular ping/pong measurements
   - RTT calculation for one-way latency
   - Dynamic latency adjustment
   - Compensation applied to playback timing

2. **Drift Correction**
   - Regular sync checks every 1 second
   - Drift threshold of 0.2 seconds
   - Gradual correction for small drifts:
     - Speed up to 1.05x if behind
     - Slow down to 0.95x if ahead
   - Immediate correction for large drifts (>1s)

3. **Host Time Management**
   - Host broadcasts current time regularly
   - Clients adjust based on host time + latency
   - Smooth transitions between states
   - Handles pause/resume/stop actions

4. **Audio Context Management**
   - Lazy initialization on first interaction
   - Automatic cleanup on session end
   - iOS-specific audio unlocking
   - Fallback handling for audio issues

5. **State Recovery**
   - Reconnection handling
   - State synchronization after disconnect
   - Audio position recovery
   - Playback state preservation

6. **Performance Optimizations**
   - Throttled time updates
   - Batched state broadcasts
   - Efficient audio buffer management
   - Memory leak prevention

### 6. Session Management
1. 5-minute inactivity timeout
2. Automatic cleanup on timeout
3. Host reassignment on disconnect
4. State reset on session end

### 7. Late Joiner Handling
1. **Before Game Start**
   - All users see waiting room
   - Host sees start button when enough players
   - Players see waiting message

2. **During Voting**
   - Late joiners skip waiting room
   - Immediately see voting screen
   - Current votes are synced
   - Can participate in voting

3. **During Playback**
   - Late joiners skip waiting room
   - See current song player
   - Audio syncs with host
   - Ready for next voting round

## Security Features
1. Host validation for controls
2. Input sanitization
3. Rate limiting on votes
4. Maximum player limit
5. Inactivity timeout

## Error Handling
1. Audio playback fallbacks
2. Connection loss recovery
3. State synchronization checks
4. Invalid vote prevention
5. iOS-specific audio handling

## Future Development Areas
1. **Potential Enhancements**
   - User authentication
   - Custom song uploads
   - Playlist management
   - Multiple voting rooms
   - Chat functionality

2. **Technical Improvements**
   - Database integration
   - Caching mechanism
   - Load balancing
   - Analytics tracking
   - Progressive Web App features

## Deployment
1. **Requirements**
   - Node.js environment
   - npm package manager
   - Port 3000 available
   - Audio file access

2. **Setup Steps**
   ```bash
   git clone [repository]
   cd vote-song
   npm install
   node server.js
   ```

## Maintenance
1. **Regular Tasks**
   - Check Socket.IO connections
   - Monitor memory usage
   - Update dependencies
   - Verify audio files
   - Test timeout mechanism

2. **Troubleshooting**
   - Check server logs
   - Verify socket connections
   - Test audio playback
   - Validate vote counting
   - Monitor state syncs

## Testing
1. **Key Test Areas**
   - Vote synchronization
   - Audio playback
   - Host controls
   - User disconnection
   - Timeout functionality

2. **Test Scenarios**
   - Multiple concurrent users
   - Host disconnection
   - Network interruption
   - Mobile device usage
   - Long session stability

## Known Limitations
1. Audio format compatibility
2. Mobile browser variations
3. Network latency effects
4. Maximum player capacity
5. Session persistence

## Support Contacts
[Add relevant contact information for support and maintenance]

## Version History
- Current Version: 1.0.0
- Last Updated: December 31, 2024
- Major Changes: 
  - Added Quick Join feature for simplified session creation
  - Implemented custom room IDs with validation
  - Enhanced session management and cleanup
  - Improved host controls and status preservation
  - Added late joiner handling for seamless session integration
  - Added audio synchronization and latency features
